<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    html, body {
      height: 100%;
    }
    #chatContainer::-webkit-scrollbar {
      width: 6px;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

<!-- Loading Fallback -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  <p class="text-lg font-semibold">Loading App...</p>
</div>

<div id="app" class="flex flex-1 min-h-0 hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col transition-transform duration-300 md:translate-x-0 -translate-x-full fixed md:relative h-full z-40">
    <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
      <h1 class="font-semibold">Chats</h1>
      <button id="newChatBtn" class="text-sm bg-blue-500 text-white px-2 py-1 rounded">New</button>
    </div>
    <div id="chatList" class="flex-1 overflow-y-auto"></div>
  </aside>

  <!-- Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black/40 hidden md:hidden z-30"></div>

  <!-- Main -->
  <main class="flex flex-col flex-1 min-h-0">

    <!-- Top Bar -->
    <div class="flex items-center justify-between p-3 border-b dark:border-gray-700 bg-white dark:bg-gray-800">
      <div class="flex items-center gap-3">
        <button id="menuBtn" class="md:hidden">‚ò∞</button>
        <h2 id="chatTitle" class="font-medium">New Chat</h2>
      </div>
      <div class="flex gap-2">
        <button id="systemBtn" class="text-sm px-2 py-1 border rounded">System</button>
        <button id="settingsBtn" class="text-sm px-2 py-1 border rounded">Settings</button>
        <button id="darkToggle" class="text-sm px-2 py-1 border rounded">üåô</button>
      </div>
    </div>

    <!-- Chat Messages -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

    <!-- Input Bar -->
    <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
      <div class="flex gap-2">
        <textarea id="messageInput" rows="1" class="flex-1 resize-none p-2 border rounded dark:bg-gray-700"></textarea>
        <button id="sendBtn" class="bg-blue-500 text-white px-4 rounded">Send</button>
      </div>
    </div>

  </main>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded w-96 space-y-4">
    <h2 class="text-lg font-semibold">Settings</h2>
    <input id="apiKeyInput" type="password" placeholder="OpenRouter API Key" class="w-full p-2 border rounded dark:bg-gray-700"/>
    <input id="modelInput" type="text" placeholder="Model Name" class="w-full p-2 border rounded dark:bg-gray-700"/>
    <div class="flex justify-end gap-2">
      <button id="closeSettings">Cancel</button>
      <button id="saveSettings" class="bg-blue-500 text-white px-3 py-1 rounded">Save</button>
    </div>
  </div>
</div>

<!-- System Prompt Modal -->
<div id="systemModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded w-96 space-y-4">
    <h2 class="text-lg font-semibold">System Prompt</h2>
    <textarea id="systemInput" rows="5" class="w-full p-2 border rounded dark:bg-gray-700"></textarea>
    <div class="flex justify-end gap-2">
      <button id="closeSystem">Cancel</button>
      <button id="saveSystem" class="bg-blue-500 text-white px-3 py-1 rounded">Save</button>
    </div>
  </div>
</div>

<script>
(function(){

/* ---------- Defensive Helpers ---------- */
function safeJSONParse(str, fallback) {
  try { return JSON.parse(str); } catch { return fallback; }
}

/* ---------- State ---------- */
let state = {
  apiKey: localStorage.getItem("apiKey") || "",
  model: localStorage.getItem("model") || "deepseek/deepseek-r1:free",
  chats: safeJSONParse(localStorage.getItem("chats"), []),
  currentChatId: localStorage.getItem("currentChatId") || null,
  dark: localStorage.getItem("dark") === "true"
};

if (state.dark) document.documentElement.classList.add("dark");

/* ---------- DOM ---------- */
const loading = document.getElementById("loading");
const app = document.getElementById("app");
const chatList = document.getElementById("chatList");
const chatContainer = document.getElementById("chatContainer");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const chatTitle = document.getElementById("chatTitle");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");

/* ---------- Init ---------- */
function init(){
  if(!state.currentChatId){
    createNewChat();
  }
  renderChats();
  renderMessages();
  loading.style.display = "none";
  app.classList.remove("hidden");
}
init();

/* ---------- Chat Management ---------- */
function createNewChat(){
  const id = Date.now().toString();
  state.chats.push({
    id,
    title: "New Chat",
    messages: [],
    systemPrompt: ""
  });
  state.currentChatId = id;
  persist();
}

function getCurrentChat(){
  return state.chats.find(c => c.id === state.currentChatId);
}

function renderChats(){
  chatList.innerHTML = "";
  state.chats.forEach(chat=>{
    const div = document.createElement("div");
    div.className="p-3 hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer flex justify-between";
    div.innerHTML = `
      <span>${chat.title}</span>
      <div class="flex gap-1">
        <button data-rename="${chat.id}">‚úèÔ∏è</button>
        <button data-delete="${chat.id}">üóëÔ∏è</button>
      </div>
    `;
    div.onclick=()=>{
      state.currentChatId=chat.id;
      persist();
      renderMessages();
    };
    chatList.appendChild(div);
  });
}

function renderMessages(){
  chatContainer.innerHTML="";
  const chat = getCurrentChat();
  if(!chat) return;
  chatTitle.textContent = chat.title;
  chat.messages.forEach(m=>{
    const div=document.createElement("div");
    div.className = m.role==="user"
      ? "text-right"
      : "text-left";
    div.innerHTML = `
      <div class="inline-block max-w-[80%] p-3 rounded-lg ${m.role==="user" ? "bg-blue-500 text-white" : "bg-gray-200 dark:bg-gray-700"}">
        ${marked.parse(m.content)}
      </div>
    `;
    chatContainer.appendChild(div);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

/* ---------- Persist ---------- */
function persist(){
  localStorage.setItem("apiKey", state.apiKey);
  localStorage.setItem("model", state.model);
  localStorage.setItem("chats", JSON.stringify(state.chats));
  localStorage.setItem("currentChatId", state.currentChatId);
  localStorage.setItem("dark", state.dark);
  renderChats();
}

/* ---------- Send Message ---------- */
async function sendMessage(){
  const text = messageInput.value.trim();
  if(!text || !state.apiKey) return alert("Missing API key");

  const chat = getCurrentChat();
  if(!chat) return;

  chat.messages.push({role:"user", content:text});
  chat.messages.push({role:"assistant", content:""});
  messageInput.value="";
  renderMessages();
  persist();

  const aiIndex = chat.messages.length-1;
  const assistantDiv = chatContainer.lastChild.querySelector("div");

  try{
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":"Bearer "+state.apiKey,
        "Content-Type":"application/json"
      },
      body: JSON.stringify({
        model: state.model,
        stream:true,
        messages:[
          ...(chat.systemPrompt ? [{role:"system", content:chat.systemPrompt}] : []),
          ...chat.messages.filter(m=>m.role!=="assistant" || m.content)
        ]
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let fullText="";

    while(true){
      const {done,value}=await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      const lines = chunk.split("\n");
      for(let line of lines){
        if(line.startsWith("data:")){
          const data=line.replace("data:","").trim();
          if(data==="[DONE]") break;
          try{
            const json=JSON.parse(data);
            const token=json.choices?.[0]?.delta?.content;
            if(token){
              fullText+=token;
              chat.messages[aiIndex].content=fullText;
              assistantDiv.innerHTML=marked.parse(fullText);
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }catch{}
        }
      }
    }
    persist();
  }catch(e){
    alert("Error fetching response");
  }
}

/* ---------- Events ---------- */
sendBtn.onclick=sendMessage;
messageInput.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

document.getElementById("newChatBtn").onclick=()=>{
  createNewChat();
  renderMessages();
};

document.getElementById("darkToggle").onclick=()=>{
  state.dark=!state.dark;
  document.documentElement.classList.toggle("dark");
  persist();
};

document.getElementById("menuBtn").onclick=()=>{
  sidebar.classList.toggle("-translate-x-full");
  overlay.classList.toggle("hidden");
};

overlay.onclick=()=>{
  sidebar.classList.add("-translate-x-full");
  overlay.classList.add("hidden");
};

/* Settings */
document.getElementById("settingsBtn").onclick=()=>{
  document.getElementById("settingsModal").classList.remove("hidden");
  document.getElementById("apiKeyInput").value=state.apiKey;
  document.getElementById("modelInput").value=state.model;
};

document.getElementById("closeSettings").onclick=()=>{
  document.getElementById("settingsModal").classList.add("hidden");
};

document.getElementById("saveSettings").onclick=()=>{
  state.apiKey=document.getElementById("apiKeyInput").value.trim();
  state.model=document.getElementById("modelInput").value.trim();
  persist();
  document.getElementById("settingsModal").classList.add("hidden");
};

/* System Prompt */
document.getElementById("systemBtn").onclick=()=>{
  const chat=getCurrentChat();
  if(!chat) return;
  document.getElementById("systemModal").classList.remove("hidden");
  document.getElementById("systemInput").value=chat.systemPrompt || "";
};

document.getElementById("closeSystem").onclick=()=>{
  document.getElementById("systemModal").classList.add("hidden");
};

document.getElementById("saveSystem").onclick=()=>{
  const chat=getCurrentChat();
  if(!chat) return;
  chat.systemPrompt=document.getElementById("systemInput").value;
  persist();
  document.getElementById("systemModal").classList.add("hidden");
};

})();
</script>

</body>
</html>
