<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Universal AI Chat</title>

  <script src="https://cdn.tailwindcss.com"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: {
              50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db', 
              400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 
              800: '#1f2937', 900: '#111827',
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Mobile safe min-height */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100dvh;
      -webkit-tap-highlight-color: transparent;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .dark ::-webkit-scrollbar-thumb {
      background: #4b5563;
    }

    /* Markdown Base Styles */
    .markdown-body p { margin-bottom: 0.75em; line-height: 1.6; }
    .markdown-body p:last-child { margin-bottom: 0; }
    .markdown-body pre {
      background-color: #1f2937;
      color: #f8f8f2;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 0.75em 0;
      font-size: 0.875rem;
    }
    .dark .markdown-body pre { background-color: #000000; }
    .markdown-body code {
      background-color: rgba(175, 184, 193, 0.2);
      padding: 0.2em 0.4em;
      border-radius: 6px;
      font-family: monospace;
      font-size: 85%;
    }
    .markdown-body pre code { background-color: transparent; padding: 0; font-size: 100%; }
    .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75em; }
    .markdown-body ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 0.75em; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
      font-weight: 600; margin-top: 1.5em; margin-bottom: 0.5em; 
    }
    .markdown-body h1 { font-size: 1.5em; }
    .markdown-body h2 { font-size: 1.25em; }
    
    /* Blinking Cursor for Typing Animation */
    .typing-cursor::after {
      content: 'â–‹';
      display: inline-block;
      animation: blink 1s step-end infinite;
      margin-left: 2px;
    }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex flex-col font-sans transition-colors duration-200 antialiased">

  <div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-[100] transition-opacity duration-300">
    <div class="flex flex-col items-center gap-3">
      <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <p class="text-lg font-medium text-gray-600 dark:text-gray-300">Loading Workspace...</p>
    </div>
  </div>

  <div id="app" class="flex flex-1 overflow-hidden hidden w-full h-[100dvh]">
    
    <aside id="sidebar" class="w-72 bg-gray-50 dark:bg-gray-800/50 border-r border-gray-200 dark:border-gray-800 flex flex-col fixed md:relative h-[100dvh] transition-transform duration-300 transform -translate-x-full md:translate-x-0 z-40 shrink-0">
      <div class="p-4 flex justify-between items-center h-16 shrink-0">
        <h1 class="font-semibold text-lg tracking-tight">Chats</h1>
        <button id="newChatBtn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg transition shadow-sm font-medium flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          New
        </button>
      </div>
      <div id="chatList" class="flex-1 overflow-y-auto px-2 pb-4 space-y-1">
        </div>
    </aside>

    <div id="overlay" class="fixed inset-0 bg-gray-900/50 dark:bg-black/60 backdrop-blur-sm hidden md:hidden z-30 transition-opacity"></div>

    <main class="flex flex-col flex-1 min-w-0 h-[100dvh] relative bg-white dark:bg-gray-900">
      
      <header class="h-16 flex items-center justify-between px-4 border-b border-gray-200 dark:border-gray-800 shrink-0 bg-white/80 dark:bg-gray-900/80 backdrop-blur z-20">
        <div class="flex items-center gap-3 min-w-0">
          <button id="menuBtn" class="md:hidden p-2 -ml-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 rounded-md">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
          </button>
          <h2 id="chatTitle" class="font-medium truncate text-lg">New Chat</h2>
        </div>
        <div class="flex items-center gap-1.5 shrink-0">
          <button id="systemBtn" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition" title="System Prompt">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
          </button>
          <button id="settingsBtn" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition" title="Settings">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </button>
          <button id="darkToggle" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition" title="Toggle Theme">
            <svg id="moonIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            <svg id="sunIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
          </button>
        </div>
      </header>

      <div id="chatContainer" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6 scroll-smooth">
        </div>

      <div class="shrink-0 p-4 bg-white dark:bg-gray-900 w-full max-w-4xl mx-auto">
        <div class="relative flex items-end border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-2xl shadow-sm focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all overflow-hidden">
          <textarea id="messageInput" rows="1" placeholder="Message Universal AI..." class="w-full max-h-48 resize-none bg-transparent border-0 focus:ring-0 p-4 pb-4 pr-14 text-gray-900 dark:text-gray-100 placeholder-gray-500 outline-none block" style="min-height: 56px;"></textarea>
          <button id="sendBtn" class="absolute right-2 bottom-2 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center h-10 w-10">
            <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V6m0 0l-5 5m5-5l5 5"></path></svg>
          </button>
        </div>
        <div class="text-center mt-2 text-xs text-gray-400 dark:text-gray-500">AI can make mistakes. Consider verifying important information.</div>
      </div>
    </main>
  </div>

  <div id="settingsModal" class="fixed inset-0 bg-gray-900/50 dark:bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-xl transform transition-all">
      <h2 class="text-xl font-semibold mb-5">Settings</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
          <input id="apiKeyInput" type="password" placeholder="sk-or-v1-..." class="w-full p-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Model Name</label>
          <input id="modelInput" type="text" placeholder="deepseek/deepseek-r1:free" class="w-full p-2.5 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"/>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-8">
        <button id="closeSettings" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium transition">Cancel</button>
        <button id="saveSettings" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">Save Settings</button>
      </div>
    </div>
  </div>

  <div id="systemModal" class="fixed inset-0 bg-gray-900/50 dark:bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-md shadow-xl transform transition-all">
      <h2 class="text-xl font-semibold mb-2">System Instructions</h2>
      <p class="text-sm text-gray-500 mb-4">Set behavior instructions for the AI in this current chat.</p>
      <textarea id="systemInput" rows="5" placeholder="You are a helpful assistant..." class="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none transition"></textarea>
      <div class="flex justify-end gap-3 mt-6">
        <button id="closeSystem" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 font-medium transition">Cancel</button>
        <button id="saveSystem" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition">Save Prompt</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      /* ---------- Defensive Helpers ---------- */
      function safeJSONParse(str, fallback) {
        if (!str) return fallback;
        try { return JSON.parse(str); } catch (e) { return fallback; }
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
      }

      function escapeHTML(str) {
        const p = document.createElement('p');
        p.textContent = str;
        return p.innerHTML;
      }

      /* ---------- Application State ---------- */
      const state = {
        apiKey: localStorage.getItem("apiKey") || "",
        model: localStorage.getItem("model") || "deepseek/deepseek-r1:free",
        chats: safeJSONParse(localStorage.getItem("chats"), []),
        currentChatId: localStorage.getItem("currentChatId") || null,
        dark: localStorage.getItem("dark") !== "false", // Default to true if not set
        isGenerating: false
      };

      /* ---------- DOM Elements ---------- */
      const dom = {
        loading: document.getElementById("loading"),
        app: document.getElementById("app"),
        chatList: document.getElementById("chatList"),
        chatContainer: document.getElementById("chatContainer"),
        messageInput: document.getElementById("messageInput"),
        sendBtn: document.getElementById("sendBtn"),
        chatTitle: document.getElementById("chatTitle"),
        sidebar: document.getElementById("sidebar"),
        overlay: document.getElementById("overlay"),
        menuBtn: document.getElementById("menuBtn"),
        newChatBtn: document.getElementById("newChatBtn"),
        
        // Settings
        settingsBtn: document.getElementById("settingsBtn"),
        settingsModal: document.getElementById("settingsModal"),
        closeSettings: document.getElementById("closeSettings"),
        saveSettings: document.getElementById("saveSettings"),
        apiKeyInput: document.getElementById("apiKeyInput"),
        modelInput: document.getElementById("modelInput"),
        
        // System Prompt
        systemBtn: document.getElementById("systemBtn"),
        systemModal: document.getElementById("systemModal"),
        closeSystem: document.getElementById("closeSystem"),
        saveSystem: document.getElementById("saveSystem"),
        systemInput: document.getElementById("systemInput"),
        
        // Theme
        darkToggle: document.getElementById("darkToggle"),
        moonIcon: document.getElementById("moonIcon"),
        sunIcon: document.getElementById("sunIcon")
      };

      /* ---------- Initialization ---------- */
      function init() {
        // Enforce data consistency
        if (!Array.isArray(state.chats)) state.chats = [];
        
        if (state.chats.length === 0 || !state.currentChatId) {
          createNewChat();
        } else {
          // Verify currentChatId actually exists in the array
          const exists = state.chats.some(c => c.id === state.currentChatId);
          if (!exists) createNewChat();
        }

        applyTheme();
        renderChats();
        renderMessages();
        
        // Auto-resize textarea
        dom.messageInput.addEventListener('input', autoResizeTextarea);

        // Hide loader and show app safely
        setTimeout(() => {
          dom.loading.classList.add("opacity-0");
          dom.app.classList.remove("hidden");
          setTimeout(() => dom.loading.style.display = "none", 300);
        }, 100);
      }

      /* ---------- State Persistance ---------- */
      function persist() {
        localStorage.setItem("apiKey", state.apiKey);
        localStorage.setItem("model", state.model);
        localStorage.setItem("chats", JSON.stringify(state.chats));
        localStorage.setItem("currentChatId", state.currentChatId);
        localStorage.setItem("dark", state.dark);
      }

      /* ---------- Theme Management ---------- */
      function applyTheme() {
        if (state.dark) {
          document.documentElement.classList.add("dark");
          dom.moonIcon.classList.add("hidden");
          dom.sunIcon.classList.remove("hidden");
        } else {
          document.documentElement.classList.remove("dark");
          dom.sunIcon.classList.add("hidden");
          dom.moonIcon.classList.remove("hidden");
        }
      }

      dom.darkToggle.onclick = () => {
        state.dark = !state.dark;
        applyTheme();
        persist();
      };

      /* ---------- Chat Management ---------- */
      function createNewChat() {
        const id = generateId();
        state.chats.unshift({ // Add to top
          id,
          title: "New Chat",
          messages: [],
          systemPrompt: ""
        });
        state.currentChatId = id;
        persist();
        renderChats();
        renderMessages();
        closeMobileSidebar();
      }

      function getCurrentChat() {
        return state.chats.find(c => c.id === state.currentChatId) || null;
      }

      function renderChats() {
        dom.chatList.innerHTML = "";
        state.chats.forEach(chat => {
          const isActive = chat.id === state.currentChatId;
          const wrapper = document.createElement("div");
          wrapper.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${
            isActive ? "bg-gray-200 dark:bg-gray-700/60 font-medium" : "hover:bg-gray-100 dark:hover:bg-gray-800"
          }`;
          
          wrapper.innerHTML = `
            <div class="flex items-center gap-3 overflow-hidden flex-1" data-select="${chat.id}">
              <svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
              <span class="truncate text-sm select-none">${escapeHTML(chat.title)}</span>
            </div>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity md:flex-none">
              <button class="p-1.5 text-gray-400 hover:text-blue-500 rounded" data-rename="${chat.id}" title="Rename">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
              </button>
              <button class="p-1.5 text-gray-400 hover:text-red-500 rounded" data-delete="${chat.id}" title="Delete">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          `;

          // Event Delegation for sidebar actions
          wrapper.querySelector(`[data-select]`).onclick = () => {
            if (state.isGenerating) return;
            state.currentChatId = chat.id;
            persist();
            renderChats();
            renderMessages();
            closeMobileSidebar();
          };

          wrapper.querySelector(`[data-rename]`).onclick = (e) => {
            e.stopPropagation();
            const newTitle = prompt("Enter new chat name:", chat.title);
            if (newTitle && newTitle.trim()) {
              chat.title = newTitle.trim();
              persist();
              renderChats();
              if (chat.id === state.currentChatId) dom.chatTitle.textContent = chat.title;
            }
          };

          wrapper.querySelector(`[data-delete]`).onclick = (e) => {
            e.stopPropagation();
            if (confirm(`Delete chat "${chat.title}"?`)) {
              state.chats = state.chats.filter(c => c.id !== chat.id);
              if (state.chats.length === 0) {
                createNewChat();
              } else if (state.currentChatId === chat.id) {
                state.currentChatId = state.chats[0].id;
              }
              persist();
              renderChats();
              renderMessages();
            }
          };

          dom.chatList.appendChild(wrapper);
        });
      }

      function renderMessages() {
        dom.chatContainer.innerHTML = "";
        const chat = getCurrentChat();
        if (!chat) return;
        
        dom.chatTitle.textContent = chat.title;

        if (chat.messages.length === 0) {
          const emptyState = document.createElement("div");
          emptyState.className = "flex flex-col items-center justify-center h-full text-gray-400 dark:text-gray-500 space-y-4 pt-20";
          emptyState.innerHTML = `
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-2">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h3 class="text-xl font-medium text-gray-800 dark:text-gray-200">How can I help you today?</h3>
          `;
          dom.chatContainer.appendChild(emptyState);
          return;
        }

        chat.messages.forEach((m, idx) => {
          appendMessageToDOM(m.role, m.content, idx);
        });
        
        scrollToBottom();
      }

      function appendMessageToDOM(role, content, index) {
        const isUser = role === "user";
        const div = document.createElement("div");
        div.id = `msg-${index}`;
        div.className = `flex w-full ${isUser ? "justify-end" : "justify-start"} animate-fade-in`;
        
        const innerContent = content ? marked.parse(content) : "";
        
        div.innerHTML = `
          <div class="${isUser ? 'max-w-[85%] md:max-w-[75%]' : 'max-w-full w-full'} flex gap-4">
            ${!isUser ? `
              <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 text-white shadow-sm mt-1 hidden md:flex">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
              </div>
            ` : ''}
            <div class="${isUser ? 'bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-gray-100 px-5 py-3.5 rounded-3xl rounded-br-sm inline-block' : 'flex-1 pt-2 pb-6 min-w-0'}">
              <div class="markdown-body text-[15px] ${!content && !isUser ? 'typing-cursor' : ''}">${innerContent}</div>
            </div>
          </div>
        `;
        dom.chatContainer.appendChild(div);
      }

      /* ---------- API Communication & Streaming ---------- */
      async function sendMessage() {
        if (state.isGenerating) return;
        
        const text = dom.messageInput.value.trim();
        if (!text) return;
        
        if (!state.apiKey) {
          alert("Please set your OpenRouter API Key in Settings first.");
          openSettings();
          return;
        }

        const chat = getCurrentChat();
        if (!chat) return;

        // Add User Message
        chat.messages.push({ role: "user", content: text });
        
        // Setup Assistant Placeholder
        chat.messages.push({ role: "assistant", content: "" });
        const aiIndex = chat.messages.length - 1;
        
        // Auto-generate title for first message
        if (chat.messages.length === 2 && chat.title === "New Chat") {
          chat.title = text.length > 30 ? text.substring(0, 30) + "..." : text;
          persist();
          renderChats();
        }

        // Reset Input
        dom.messageInput.value = "";
        autoResizeTextarea();
        renderMessages(); // Renders up to the blank AI placeholder

        state.isGenerating = true;
        dom.sendBtn.disabled = true;
        dom.sendBtn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;

        const aiMessageNode = document.getElementById(`msg-${aiIndex}`);
        const contentContainer = aiMessageNode.querySelector('.markdown-body');

        // Construct Request Messages
        const apiMessages = [];
        if (chat.systemPrompt) {
          apiMessages.push({ role: "system", content: chat.systemPrompt });
        }
        apiMessages.push(...chat.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content })));

        try {
          const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${state.apiKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: state.model,
              stream: true,
              messages: apiMessages
            })
          });

          if (!response.ok) {
            const errJSON = await response.json().catch(()=>({}));
            throw new Error(errJSON.error?.message || `HTTP ${response.status} Error`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";
          let fullText = "";

          // Read stream chunks
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            
            // Keep the last incomplete line in the buffer
            buffer = lines.pop() || ""; 

            for (const line of lines) {
              const trimmed = line.trim();
              if (trimmed.startsWith("data: ")) {
                const dataStr = trimmed.slice(6).trim();
                if (dataStr === "[DONE]") continue;
                
                try {
                  const data = JSON.parse(dataStr);
                  const token = data.choices?.[0]?.delta?.content;
                  if (token) {
                    if (fullText.length === 0) contentContainer.classList.remove('typing-cursor');
                    fullText += token;
                    contentContainer.innerHTML = marked.parse(fullText);
                    
                    // Keep auto-scrolling if user is near bottom
                    const isNearBottom = dom.chatContainer.scrollHeight - dom.chatContainer.scrollTop - dom.chatContainer.clientHeight < 150;
                    if (isNearBottom) scrollToBottom();
                  }
                } catch (e) {
                  // Silent catch for partial/malformed JSON chunks
                }
              }
            }
          }

          // Finalize stream
          contentContainer.classList.remove('typing-cursor');
          chat.messages[aiIndex].content = fullText;
          persist();

        } catch (err) {
          console.error(err);
          contentContainer.classList.remove('typing-cursor');
          contentContainer.innerHTML = `<span class="text-red-500">Error: ${escapeHTML(err.message || "Failed to fetch response")}</span>`;
          chat.messages.pop(); // Remove empty AI message on failure
        } finally {
          state.isGenerating = false;
          dom.sendBtn.disabled = false;
          dom.sendBtn.innerHTML = `<svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V6m0 0l-5 5m5-5l5 5"></path></svg>`;
          persist();
        }
      }

      /* ---------- UI Helpers & Event Listeners ---------- */
      function scrollToBottom() {
        dom.chatContainer.scrollTop = dom.chatContainer.scrollHeight;
      }

      function autoResizeTextarea() {
        dom.messageInput.style.height = 'auto';
        const scrollHeight = dom.messageInput.scrollHeight;
        dom.messageInput.style.height = scrollHeight < 200 ? scrollHeight + 'px' : '200px';
      }

      function closeMobileSidebar() {
        dom.sidebar.classList.add("-translate-x-full");
        dom.overlay.classList.add("hidden");
      }

      function openSettings() {
        dom.settingsModal.classList.remove("hidden", "opacity-0");
        dom.settingsModal.classList.add("flex");
        dom.apiKeyInput.value = state.apiKey;
        dom.modelInput.value = state.model;
      }

      dom.sendBtn.onclick = sendMessage;

      dom.messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          // Mobile keyboard check - avoid sending if user is swiping/composing
          if (e.isComposing || e.keyCode === 229) return;
          sendMessage();
        }
      });

      dom.newChatBtn.onclick = () => {
        if (!state.isGenerating) createNewChat();
      };

      // Sidebar Mobile Toggles
      dom.menuBtn.onclick = () => {
        dom.sidebar.classList.remove("-translate-x-full");
        dom.overlay.classList.remove("hidden");
      };
      dom.overlay.onclick = closeMobileSidebar;

      // Settings Events
      dom.settingsBtn.onclick = openSettings;
      
      dom.closeSettings.onclick = () => {
        dom.settingsModal.classList.add("hidden");
        dom.settingsModal.classList.remove("flex");
      };
      
      dom.saveSettings.onclick = () => {
        state.apiKey = dom.apiKeyInput.value.trim();
        state.model = dom.modelInput.value.trim() || "deepseek/deepseek-r1:free";
        persist();
        dom.closeSettings.click();
      };

      // System Prompt Events
      dom.systemBtn.onclick = () => {
        const chat = getCurrentChat();
        if (!chat) return;
        dom.systemModal.classList.remove("hidden", "opacity-0");
        dom.systemModal.classList.add("flex");
        dom.systemInput.value = chat.systemPrompt || "";
      };

      dom.closeSystem.onclick = () => {
        dom.systemModal.classList.add("hidden");
        dom.systemModal.classList.remove("flex");
      };

      dom.saveSystem.onclick = () => {
        const chat = getCurrentChat();
        if (!chat) return;
        chat.systemPrompt = dom.systemInput.value;
        persist();
        dom.closeSystem.click();
      };

      // Boot App
      init();

    })();
  </script>
</body>
</html>
